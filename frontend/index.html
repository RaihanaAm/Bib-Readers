<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>BibReaders ¬∑ Catalogue</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="px-6 py-4 bg-white shadow">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <h1 class="text-xl font-bold">üìö BibReaders</h1>
      <nav class="space-x-4">
        <a href="/" class="text-sm hover:underline">Accueil</a>
        <a href="/reco" class="text-sm hover:underline">Recommandations</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-6 space-y-10">
    <!-- Search -->
    <section class="bg-white rounded-2xl shadow p-4">
      <div class="flex gap-2">
        <input id="searchInput" type="text" placeholder="Rechercher par titre..."
               class="flex-1 border rounded-xl px-3 py-2" />
        <button id="searchBtn"
                class="px-4 py-2 rounded-xl bg-slate-900 text-white">Rechercher</button>
      </div>
    </section>

    <!-- Random -->
    <section class="space-y-3">
      <h2 class="text-lg font-semibold">S√©lection al√©atoire</h2>
      <div id="randomGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
    </section>

    <!-- Top rated -->
    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Mieux not√©s</h2>
      </div>
      <div id="topGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
    </section>

    <!-- Paged catalogue -->
    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Catalogue</h2>
        <div class="text-sm" id="pagerInfo"></div>
      </div>
      <div id="catalogGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
      <div class="flex items-center justify-center gap-2">
        <button id="prevBtn" class="px-3 py-1 border rounded-lg">‚Üê Page pr√©c√©dente</button>
        <button id="nextBtn" class="px-3 py-1 border rounded-lg">Page suivante ‚Üí</button>
      </div>
    </section>
  </main>

  <script>
    const API = (path) => `${location.origin}${path}`;

    function card(b) {
      const price = typeof b.price === 'number' ? b.price.toFixed(2) : (b.price || '');
      return `
      <a href="/detail?id=${b.id}" class="block bg-white rounded-xl shadow hover:shadow-md transition">
        <img src="${b.image_url || ''}" alt="${b.title}" class="w-full h-44 object-cover rounded-t-xl">
        <div class="p-3 space-y-1">
          <div class="font-semibold line-clamp-2">${b.title}</div>
          <div class="text-xs text-slate-500">${b.author || '‚Äî'}</div>
          <div class="text-sm">‚≠ê ${b.rating ?? 0} ¬∑ ${price}¬£</div>
        </div>
      </a>`;
    }

    // Random
    async function loadRandom() {
      const res = await fetch(API('/api/livres/random?n=8'));
      const data = await res.json();
      document.getElementById('randomGrid').innerHTML = data.map(card).join('');
    }

    // Top rated
    async function loadTop() {
      const res = await fetch(API('/api/livres/top-rated?limit=8'));
      const data = await res.json();
      document.getElementById('topGrid').innerHTML = data.map(card).join('');
    }

    // Paged catalogue
    let page = 1, pageSize = 12, currentQuery = '';

    async function loadPage() {
      const url = new URL(API('/api/livres'));
      url.searchParams.set('page', page);
      url.searchParams.set('page_size', pageSize);
      if (currentQuery) url.searchParams.set('q', currentQuery);

      const res = await fetch(url);
      const data = await res.json();
      const { items = [], total = 0 } = data || {};

      document.getElementById('catalogGrid').innerHTML = items.map(card).join('');
      document.getElementById('pagerInfo').textContent =
        `Page ${page} ¬∑ ${items.length} √©l√©ments ¬∑ Total ${total}`;
    }

    // Search
    document.getElementById('searchBtn').addEventListener('click', () => {
      currentQuery = document.getElementById('searchInput').value.trim();
      page = 1;
      loadPage();
    });

    // Pager
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (page > 1) { page--; loadPage(); }
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      page++; loadPage();
    });

    // Init
    loadRandom();
    loadTop();
    loadPage();
  </script>
</body>
</html>
